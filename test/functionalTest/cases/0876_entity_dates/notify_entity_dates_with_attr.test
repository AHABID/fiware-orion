# Copyright 2016 Telefonica Investigacion y Desarrollo, S.A.U
#
# This file is part of Orion Context Broker.
#
# Orion Context Broker is free software: you can redistribute it and/or
# modify it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# Orion Context Broker is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero
# General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with Orion Context Broker. If not, see http://www.gnu.org/licenses/.
#
# For those usages not covered by this license please contact with
# iot_support at tid dot es

# VALGRIND_READY - to mark the test ready for valgrindTestSuite.sh

--NAME--
Notify entity dates as attributes

--SHELL-INIT--
dbInit CB
brokerStart CB
accumulatorStart --pretty-print

--SHELL--

#
# 01a. Create sub1 for E1 with attrs: dateCreated
# 01b. Create entity E1 with attribute A and B
# 01c. Dump and reset: see E1 with attribute dateCreated
#
# 02a. Create sub2 for E2 with attrs: dateModified
# 02b. Create entity E2 with attribute A and B
# 02c. Dump and reset: see E2 with attribute dateModified
#
# 03a. Create sub3 for E3 with attrs: dateCreated,dateModified
# 03b. Create entity E3 with attribute A and B
# 03c. Dump and reset: see E3 with attributes dateCreated and dateModified
#
# 04a. Create sub4 for E4 with attrs: dateModified,dateCreated,*
# 04b. Create entity E4 with attribute A and B
# 04c. Dump and reset: see E4 with attributes A, B, dateCreated, dateModified
#
# 05a. Create sub5 for E5 with attrs: dateModified,dateCreated,A
# 05b. Create entity E5 with attribute A and B
# 05c. Dump and reset: see E5 with attributes A, dateCreated, dateModified
#
# 06a. Create sub6 for E6 with attrs: B
# 06b. Create entity E6 with attribute A and B
# 06c. Dump and reset: see E6 with attribute B
#

echo "01a. Create sub1 for E1 with attrs: dateCreated"
echo "==============================================="
payload='{
    "subject": {
        "entities": [
            {
                "id": "E1",
                "type": "T"
            }
        ],
        "condition": {
            "attrs": [ ]
         }
    },
    "notification": {
        "http": {"url": "http://localhost:'$LISTENER_PORT'/notify"},
        "attrs": [ "dateCreated" ]
    },
    "expires": "2050-04-05T14:00:00.00Z"
}'
orionCurl --url /v2/subscriptions --payload "$payload"
echo
echo


echo "01b. Create entity E1 with attribute A and B"
echo "============================================"
payload='{
  "id": "E1",
  "type": "T",
  "A": 1,
  "B": 10
}'
orionCurl --url /v2/entities?options=keyValues --payload "$payload"
echo
echo


echo "01c. Dump and reset: see E1 with attribute dateCreated"
echo "======================================================"
accumulatorDump
accumulatorReset
echo
echo


echo "02a. Create sub2 for E2 with attrs: dateModified"
echo "================================================"
payload='{
    "subject": {
        "entities": [
            {
                "id": "E2",
                "type": "T"
            }
        ],
        "condition": {
            "attrs": [ ]
         }
    },
    "notification": {
        "http": {"url": "http://localhost:'$LISTENER_PORT'/notify"},
        "attrs": [ "dateModified" ]
    },
    "expires": "2050-04-05T14:00:00.00Z"
}'
orionCurl --url /v2/subscriptions --payload "$payload"
echo
echo


echo "02b. Create entity E2 with attribute A and B"
echo "============================================"
payload='{
  "id": "E2",
  "type": "T",
  "A": 2,
  "B": 20
}'
orionCurl --url /v2/entities?options=keyValues --payload "$payload"
echo
echo


echo "02c. Dump and reset: see E2 with attribute dateModified"
echo "======================================================="
accumulatorDump
accumulatorReset
echo
echo


echo "03a. Create sub3 for E3 with attrs: dateCreated,dateModified"
echo "============================================================"
payload='{
    "subject": {
        "entities": [
            {
                "id": "E3",
                "type": "T"
            }
        ],
        "condition": {
            "attrs": [ ]
         }
    },
    "notification": {
        "http": {"url": "http://localhost:'$LISTENER_PORT'/notify"},
        "attrs": [ "dateCreated", "dateModified" ]
    },
    "expires": "2050-04-05T14:00:00.00Z"
}'
orionCurl --url /v2/subscriptions --payload "$payload"
echo
echo


echo "03b. Create entity E3 with attribute A and B"
echo "============================================"
payload='{
  "id": "E3",
  "type": "T",
  "A": 3,
  "B": 30
}'
orionCurl --url /v2/entities?options=keyValues --payload "$payload"
echo
echo


echo "03c. Dump and reset: see E3 with attributes dateCreated and dateModified"
echo "========================================================================"
accumulatorDump
accumulatorReset
echo
echo


echo "04a. Create sub4 for E4 with attrs: dateModified,dateCreated,*"
echo "=============================================================="
payload='{
    "subject": {
        "entities": [
            {
                "id": "E4",
                "type": "T"
            }
        ],
        "condition": {
            "attrs": [ ]
         }
    },
    "notification": {
        "http": {"url": "http://localhost:'$LISTENER_PORT'/notify"},
        "attrs": [ "dateModified", "dateCreated", "*" ]
    },
    "expires": "2050-04-05T14:00:00.00Z"
}'
orionCurl --url /v2/subscriptions --payload "$payload"
echo
echo


echo "04b. Create entity E4 with attribute A and B"
echo "============================================"
payload='{
  "id": "E4",
  "type": "T",
  "A": 4,
  "B": 40
}'
orionCurl --url /v2/entities?options=keyValues --payload "$payload"
echo
echo


echo "04c. Dump and reset: see E4 with attributes A, B, dateCreated, dateModified"
echo "==========================================================================="
accumulatorDump
accumulatorReset
echo
echo


echo "05a. Create sub5 for E5 with attrs: dateModified,dateCreated,A"
echo "=============================================================="
payload='{
    "subject": {
        "entities": [
            {
                "id": "E5",
                "type": "T"
            }
        ],
        "condition": {
            "attrs": [ ]
         }
    },
    "notification": {
        "http": {"url": "http://localhost:'$LISTENER_PORT'/notify"},
        "attrs": [ "dateModified", "dateCreated", "A" ]
    },
    "expires": "2050-04-05T14:00:00.00Z"
}'
orionCurl --url /v2/subscriptions --payload "$payload"
echo
echo


echo "05b. Create entity E5 with attribute A and B"
echo "============================================"
payload='{
  "id": "E5",
  "type": "T",
  "A": 5,
  "B": 50
}'
orionCurl --url /v2/entities?options=keyValues --payload "$payload"
echo
echo


echo "05c. Dump and reset: see E5 with attributes A, dateCreated, dateModified"
echo "========================================================================"
accumulatorDump
accumulatorReset
echo
echo


echo "06a. Create sub6 for E6 with attrs: B"
echo "====================================="
payload='{
    "subject": {
        "entities": [
            {
                "id": "E6",
                "type": "T"
            }
        ],
        "condition": {
            "attrs": [ ]
         }
    },
    "notification": {
        "http": {"url": "http://localhost:'$LISTENER_PORT'/notify"},
        "attrs": [ "B" ]
    },
    "expires": "2050-04-05T14:00:00.00Z"
}'
orionCurl --url /v2/subscriptions --payload "$payload"
echo
echo


echo "06b. Create entity E6 with attributes A and B"
echo "============================================="
payload='{
  "id": "E6",
  "type": "T",
  "A": 6,
  "B": 60
}'
orionCurl --url /v2/entities?options=keyValues --payload "$payload"
echo
echo


echo "06c. Dump and reset: see E6 with attribute B"
echo "============================================"
accumulatorDump
accumulatorReset
echo
echo


--REGEXPECT--
01. At t_0: Create subscription with q: dateCreated==t_2..t_6
=============================================================
HTTP/1.1 201 Created
Content-Length: 0
Location: /v2/subscriptions/REGEX([0-9a-f]{24})
Fiware-Correlator: REGEX([0-9a-f\-]{36})
Date: REGEX(.*)

07. Get accumulator dump (3 notifications): E2, E3, E4
======================================================
POST http://localhost:REGEX(\d+)/notify
Content-Length: 126
User-Agent: orion/REGEX(\d+\.\d+\.\d+.*)
Ngsiv2-Attrsformat: normalized
Host: localhost:REGEX(\d+)
Accept: application/json
Content-Type: application/json; charset=utf-8
Fiware-Correlator: REGEX([0-9a-f\-]{36})


--TEARDOWN--
brokerStop CB
accumulatorStop $LISTENER_PORT
#dbDrop CB
