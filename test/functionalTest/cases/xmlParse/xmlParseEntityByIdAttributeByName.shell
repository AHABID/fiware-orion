echo "1: ++++++++++++++++++++"
# Make a registration using conv op /NGSI9/contextEntities/ENTITY_ID/attributes/ATTRIBUTE_01
url="/NGSI9/contextEntities/ENTITY_ID/attributes/ATTRIBUTE_01"
payload='<?xml version="1.0" encoding="UTF-8"?>
<registerProviderRequest>
  <metadata>
    <contextMetadata>
      <name>ID</name>
      <type>string</type>
      <value>1110</value>
    </contextMetadata>
    <contextMetadata>
      <name>cm2</name>
      <type>string</type>
      <value>XXX</value>
    </contextMetadata>
  </metadata>
  <duration>PT1H</duration>
  <providingApplication>http://kz.tid.es/abc</providingApplication>
</registerProviderRequest>'
curlXml ${url} "${payload}"

REG_ID=$(echo "$response" | grep registrationId | awk -F '>' '{print $2}' | awk -F '<' '{print $1}' | grep -v '^$' )

# Make a discovery to see that the registration went OK
echo "2: ++++++++++++++++++++"
url="/NGSI9/discoverContextAvailability"
payload='<?xml version="1.0"?>
  <discoverContextAvailabilityRequest>
    <entityIdList>
      <entityId type="" isPattern="true">
        <id>ENTITY_ID</id>
      </entityId>
    </entityIdList>
  </discoverContextAvailabilityRequest>'
curlXml ${url} "${payload}"

# Modify the first registration
echo "3: ++++++++++++++++++++"
url="/NGSI9/contextEntities/ENTITY_ID/attributes/ATTRIBUTE_01"
payload='<?xml version="1.0" encoding="UTF-8"?>
<registerProviderRequest>
  <metadata>
    <contextMetadata>
      <name>ID</name>
      <type>string</type>
      <value>1111</value>
    </contextMetadata>
    <contextMetadata>
      <name>cm2</name>
      <type>string</type>
      <value>YYY</value>
    </contextMetadata>
  </metadata>
  <duration>PT2H</duration>
  <providingApplication>http://kz.tid.es/abc2</providingApplication>
  <registrationId>'$REG_ID'</registrationId>
</registerProviderRequest>'
curlXml ${url} "${payload}"

echo "4: ++++++++++++++++++++"

# Now discover that very registration again to see the change
url="/NGSI9/discoverContextAvailability"
payload='<?xml version="1.0"?>
  <discoverContextAvailabilityRequest>
    <entityIdList>
      <entityId type="" isPattern="true">
        <id>ENTITY_ID</id>
      </entityId>
    </entityIdList>
  </discoverContextAvailabilityRequest>'
curlXml ${url} "${payload}"

echo "5: ++++++++++++++++++++"

# Now try the GET method
curlXmlNoPayload "/NGSI9/contextEntities/ENTITY_ID/attributes/ATTRIBUTE_01"

echo "6: ++++++++++++++++++++"

# And a GET that fails
curlXmlNoPayload "/NGSI9/contextEntities/ENTITY_ID2/attributes"

echo "7: ++++++++++++++++++++"

# DELETE and PUT should give errors
curlXmlNoPayload "/NGSI9/contextEntities/ENTITY_ID/attributes/ATTRIBUTE_01" "-X DELETE"

echo "8: ++++++++++++++++++++"

url="/NGSI9/contextEntities/ENTITY_ID/attributes/ATTRIBUTE_01"
payload='<?xml version="1.0" encoding="UTF-8"?>
<registerProviderRequest>
  <metadata>
    <contextMetadata>
      <name>ID</name>
      <type>string</type>
      <value>1111</value>
    </contextMetadata>
    <contextMetadata>
      <name>cm2</name>
      <type>string</type>
      <value>YYY</value>
    </contextMetadata>
  </metadata>
  <duration>PT2H</duration>
  <providingApplication>http://kz.tid.es/abc2</providingApplication>
</registerProviderRequest>'
curlXml ${url} "${payload}" "-X PUT"

echo "9: ++++++++++++++++++++"

